# SmsAlarm 项目文档

## 1. 项目概览

SmsAlarm 是一个 Android 应用，用于监听短信类通知并在命中特定关键字后触发高优先级报警。
当前默认规则：当通知正文包含 `上海交警` 时触发报警。

### 1.1 设计目标

- 在不读取短信数据库的前提下实现“短信提醒增强”。
- 使用通知监听能力，降低对短信权限的依赖。
- 命中后立即拉起前台报警服务，保证提醒的可感知性。

---

## 2. 功能说明

### 2.1 核心流程

1. 用户在主界面点击“启用监控”。
2. 应用检查并引导开启通知监听权限。
3. 后台守护服务启动，持续保持监控可用性。
4. `SmsNotificationListener` 接收新通知并做筛选：
   - 来源包名是否疑似短信应用。
   - 通知是否是新消息（去重）。
   - 文本是否包含关键字 `上海交警`。
   - 是否通过防抖窗口（5 分钟内仅触发一次）。
5. 命中后启动 `AlarmService`：
   - 将报警/媒体音量拉满。
   - 请求音频焦点。
   - 循环播放 `res/raw/alarm.mp3`。
   - 在通知中提供“停止报警”按钮。
   - 最长 10 分钟后自动停止。

### 2.2 主要特性

- 单按钮监控开关，状态持久化。
- 兼容 Android 13+ 的通知权限申请。
- 报警服务支持手动停止与超时自动停止。

---

## 3. 架构与模块

### 3.1 模块分层

- **UI 层**：`MainActivity`
- **配置层**：`MonitorConfig`（SharedPreferences）
- **监听层**：`SmsNotificationListener`
- **执行层**：`AlarmService`、`KeepAliveService`

### 3.2 关键类职责

- `MainActivity`
  - 申请运行时权限。
  - 引导用户进入通知监听设置页。
  - 控制监控开关和守护服务启动/停止。
- `MonitorConfig`
  - 读写“是否启用监控”状态。
- `SmsNotificationListener`
  - 对通知做来源过滤、内容匹配、去重与防抖。
  - 命中后启动报警服务。
- `AlarmService`
  - 创建高优先级前台通知。
  - 申请音频焦点、播放循环报警音。
  - 响应“停止报警”Action。
- `KeepAliveService`
  - 以低优先级前台服务维持监控活性。

---

## 4. 权限与系统要求

### 4.1 Manifest 权限

- `POST_NOTIFICATIONS`
- `FOREGROUND_SERVICE`
- `FOREGROUND_SERVICE_MEDIA_PLAYBACK`
- `FOREGROUND_SERVICE_DATA_SYNC`
- `MODIFY_AUDIO_SETTINGS`
- `WAKE_LOCK`

### 4.2 用户手动配置

必须在系统设置中授予该应用**通知使用权（Notification access）**，否则监听服务无法接收通知。

---

## 5. 运行与构建

### 5.1 环境要求

- JDK 11
- Android SDK 34
- Android Studio Hedgehog 或更高版本

### 5.2 调试构建

```bash
./gradlew :app:assembleDebug
```

安装 APK（示例）：

```bash
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### 5.3 Release 构建

`app/build.gradle` 默认从以下环境变量读取签名信息：

- `KEYSTORE_PASSWORD`
- `KEY_ALIAS`
- `KEY_PASSWORD`

构建命令：

```bash
./gradlew :app:assembleRelease
```

---

## 6. 配置项与可扩展点

### 6.1 当前硬编码项

- 关键字：`上海交警`
- 防抖时长：5 分钟
- 报警最大持续时长：10 分钟
- 短信来源包名规则：Google Messages / AOSP MMS / 包名包含 `sms`

### 6.2 建议的后续优化

- 将关键字、包名白名单、防抖时间暴露到设置页。
- 支持多关键字与正则匹配。
- 增加报警日志页（触发时间、来源应用、匹配文本摘要）。
- 增加“仅耳机/蓝牙输出时报警”等音频策略。

---

## 7. 隐私与合规说明

- 本项目基于通知监听能力处理通知文本，不直接读取短信数据库。
- 当前代码未包含上传通知内容到外部服务器的逻辑。
- 若用于生产环境，请按目标地区法规补充隐私政策与用户授权说明。
